---
import { getCollection } from 'astro:content';

// 1. Fetch & Sort Data
const allThreats = await getCollection('wordpress-threats');
const recentThreats = allThreats
  .sort(
    (a, b) =>
      new Date(b.data.reportDate).valueOf() -
      new Date(a.data.reportDate).valueOf(),
  )
  .slice(0, 6)
  .reverse();

// 2. Helper for Severity Colors (Matches your original terminal colors)
const getStatusColor = (severity: string) => {
  switch (severity) {
    case 'Critical':
      return 'text-rose-400'; // Red
    case 'High':
      return 'text-yellow-400'; // Yellow (Warning)
    case 'Medium':
      return 'text-blue-400'; // Blue (Action)
    default:
      return 'text-emerald-400'; // Green (Success/Info)
  }
};

// 3. Date Formatter
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
  }).format(date);
};
---

<section class='rounded-xl'>
  <div class='mb-8 text-center'>
    <h2
      class='mb-4 font-bold text-gray-900 dark:text-white text-3xl text-center'>
      Live Activity Log
    </h2>
    <p class='mb-12 text-slate-700 dark:text-slate-300 text-center'>
      Real problems I'm solving daily.
    </p>
  </div>
  <div class='mx-auto max-w-4xl'>
    <div
      class='bg-slate-900 shadow-2xl border border-slate-800 rounded-lg overflow-hidden'>
      <div
        class='flex items-center gap-2 bg-slate-800 px-4 py-2 border-slate-700 border-b'>
        <div class='bg-red-500 rounded-full w-3 h-3'></div>
        <div class='bg-yellow-500 rounded-full w-3 h-3'></div>
        <div class='bg-green-500 rounded-full w-3 h-3'></div>
        <span class='ml-2 font-mono text-slate-400 text-xs'
          >user@security-console:~/recent-fixes</span
        >
      </div>
      <div
        class='space-y-3 p-6 h-64 font-mono text-xs sm:text-sm terminal-scroll'>
        {/* Dynamic Data Loop */}
        {
          recentThreats.map((threat) => (
            <div class='flex gap-4'>
              <span class='text-slate-500 shrink-0'>
                [{formatDate(threat.data.reportDate)}]
              </span>
              <div class='flex sm:flex-row flex-col sm:gap-2'>
                <span
                  class={`font-bold uppercase ${getStatusColor(threat.data.severity)}`}>
                  {threat.data.severity}:
                </span>
                <a
                  href={`/wordpress-threats/${threat.slug}`}
                  class='text-slate-300 hover:text-white decoration-slate-600 hover:underline underline-offset-2 transition-colors'>
                  {threat.data.title}
                </a>
              </div>
            </div>
          ))
        }

        {/* Static "Pulse" Animation at the bottom to keep the live feel */}
        <div class='flex gap-4 animate-pulse'>
          <span class='text-slate-500 shrink-0'>[NOW]</span>
          <div class='flex sm:flex-row flex-col sm:gap-2'>
            <span class='font-bold text-blue-400'>SCANNING:</span>
            <span class='text-slate-300'
              >Analyzing suspicious admin user creation...</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
