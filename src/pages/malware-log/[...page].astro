---
// src/pages/malware-log/[...page].astro
import BlogPosts from '../../components/BlogPosts.astro';
import ComponentWrapper from '../../components/component-wrapper.astro';
import Layout from '../../layouts/Layout.astro';
import { wordpress } from '../../lib/wordpress';

// --- 1. Generate Static Paths ---
export async function getStaticPaths() {
  const PER_PAGE = 10;

  // ✅ OPTIMIZATION: Fetch ALL malware logs once (Cached).
  // This uses the cached "getAllPosts" method with a specific postType.
  const allLogs = await wordpress.getAllPosts({
    postType: 'malware-log', // <--- Creates cache key 'all-malware-log'
    _fields: [
      'id',
      'slug',
      'title',
      'excerpt',
      'date',
      'featured_media',
      '_embedded',
      'categories',
    ],
  });

  // Calculate total pages locally
  const totalPages = Math.ceil(allLogs.length / PER_PAGE);

  // Generate routes for all pages
  return Array.from({ length: totalPages }, (_, i) => {
    const pageNum = i + 1;

    // Slice data for this specific page locally
    const start = i * PER_PAGE;
    const end = start + PER_PAGE;
    const pagePosts = allLogs.slice(start, end);

    return {
      // Page 1 matches '/malware-log' (undefined param)
      // Page 2 matches '/malware-log/2', etc.
      params: { page: pageNum === 1 ? undefined : pageNum.toString() },
      // ✅ Pass data directly to props so the component doesn't fetch again
      props: { posts: pagePosts, totalPages },
    };
  });
}

// --- 2. Extract current page from Params ---
const { page } = Astro.params;
// ✅ Receive the pre-sliced posts
const { posts, totalPages } = Astro.props;

const currentPage = page ? Number(page) : 1;

// --- 3. Dynamic SEO Settings ---
const isFirstPage = currentPage === 1;
const baseUrl = 'https://www.mdpabel.com/malware-log';

const seoTitle = isFirstPage
  ? 'Malware Logs: WordPress Security Analysis & Remediation'
  : `Malware Logs (Page ${currentPage}) | Security Insights`;

const seoDesc = isFirstPage
  ? 'Detailed logs of malware discoveries, analyses, and remediations from client WordPress websites. Insights into common threats and cleanup strategies.'
  : `Page ${currentPage} of our malware logs. Read technical breakdowns of malware infections, detection methods, and remediation steps.`;

const canonicalURL = isFirstPage ? baseUrl : `${baseUrl}/${currentPage}`;
---

<Layout
  title={seoTitle}
  description={seoDesc}
  image='/images/malware-log-opengraph-image.png'
  canonical={canonicalURL}>
  <ComponentWrapper class='pt-12'>
    <BlogPosts
      posts={posts}
      totalPages={totalPages}
      postType='malware-log'
      rootSlug='malware-log'
      page={currentPage}
      limit={10}
      title='Malware Logs: Analysis & Remediation Insights'
      shortDescription='In-depth analyses of malware infections, detection methods, and remediation strategies from real client sites.'
      mode='all'
    />
  </ComponentWrapper>
</Layout>
