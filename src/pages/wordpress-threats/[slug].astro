---
import { getCollection, render, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. Generate Static Paths
export async function getStaticPaths() {
  const threats = await getCollection('wordpress-threats');
  return threats.map((entry) => ({
    params: { slug: entry.data.slug || entry.slug },
    props: { entry },
  }));
}

// 2. Define the Type for Props
interface Props {
  entry: CollectionEntry<'wordpress-threats'>;
}

const { entry } = Astro.props;

// 3. Render Content
const { Content } = await render(entry);
const data = entry.data;

// Logic for Badges
const isFUD =
  data.vtScore?.includes('0/') || data.vtScore?.includes('Undetected');
const isZeroDay = data.vtScore?.includes('Zero-Day');

// Severity Colors (Optimized for Dark Mode)
const severityColor =
  data.severity === 'Critical'
    ? 'bg-red-900/40 text-red-400 border-red-800'
    : data.severity === 'High'
      ? 'bg-orange-900/40 text-orange-400 border-orange-800'
      : 'bg-blue-900/40 text-blue-400 border-blue-800';

// Difficulty Colors
const diffColor =
  data.difficulty === 'Hard'
    ? 'text-red-500'
    : data.difficulty === 'Moderate'
      ? 'text-orange-500'
      : 'text-green-500';

const proseClasses =
  'prose-invert max-w-none prose prose-lg ' +
  'prose-headings:font-bold prose-headings:text-white prose-headings:border-b prose-headings:border-slate-800 prose-headings:pb-2 ' +
  'prose-p:text-slate-300 prose-p:leading-relaxed ' +
  'prose-strong:text-white ' +
  'prose-ul:text-slate-300 prose-ol:text-slate-300 prose-li:mb-2 ' +
  'prose-code:text-pink-400 prose-code:break-words ' +
  'prose-img:rounded-lg prose-img:border prose-img:border-slate-700 prose-img:shadow-lg';
---

<Layout
  title={`${data.title} | Threat Report`}
  description={data.description ||
    'Detailed analysis of WordPress threats and malware.'}>
  <main class='mx-auto px-4 py-12 max-w-4xl'>
    {/* --- HEADER --- */}
    <header class='mb-8 pb-8 border-slate-800 border-b'>
      <div class='flex flex-wrap items-center gap-3 mb-4'>
        <span
          class={`px-3 py-1 rounded-full text-xs font-bold border uppercase tracking-wide ${severityColor}`}>
          {data.severity}
        </span>

        <span
          class='bg-slate-800 px-3 py-1 border border-slate-700 rounded-full font-medium text-slate-400 text-xs'>
          {data.threatType}
        </span>

        {
          isFUD && (
            <a
              href={data.vtLink}
              target='_blank'
              class='flex items-center gap-2 bg-purple-900/40 hover:bg-purple-900/60 px-3 py-1 border border-purple-800 rounded-full font-bold text-purple-400 text-xs uppercase transition-colors animate-pulse'>
              üëª Fully Undetected (0/61)
            </a>
          )
        }

        {
          isZeroDay && (
            <span class='bg-slate-700 px-3 py-1 border border-slate-600 rounded-full font-bold text-white text-xs uppercase'>
              üõ°Ô∏è Zero-Day Variant
            </span>
          )
        }
      </div>

      <h1 class='mb-2 font-extrabold text-white text-3xl md:text-4xl'>
        {data.title}
      </h1>
      <p class='font-mono text-slate-500 text-sm'>
        Case ID: {data.fileHash} ‚Ä¢ Detected: {data.reportDate}
      </p>
    </header>

    {/* --- FIELD NOTES GRID --- */}
    <div class='gap-4 grid grid-cols-2 md:grid-cols-4 mb-10'>
      {/* Impact */}
      <div class='bg-slate-900 p-4 border border-slate-800 rounded-xl'>
        <span
          class='block mb-1 text-[10px] text-slate-500 uppercase tracking-wider'
          >Impact Radius</span
        >
        <div class='font-bold text-white text-lg leading-tight'>
          {data.seenOn || 'Single Site'}
        </div>
      </div>

      {/* Difficulty */}
      <div class='bg-slate-900 p-4 border border-slate-800 rounded-xl'>
        <span
          class='block mb-1 text-[10px] text-slate-500 uppercase tracking-wider'
          >Removal Difficulty</span
        >
        <div class={`font-bold text-lg ${diffColor}`}>
          {data.difficulty || 'Unknown'}
        </div>
      </div>

      {/* Recurrence */}
      <div class='bg-slate-900 p-4 border border-slate-800 rounded-xl'>
        <span
          class='block mb-1 text-[10px] text-slate-500 uppercase tracking-wider'
          >Recurrence Rate</span
        >
        <div class='font-bold text-white text-lg'>
          {data.recurrence || 'Low'}
        </div>
      </div>

      {/* Behavior */}
      <div
        class='col-span-2 md:col-span-1 bg-slate-900 p-4 border border-slate-800 rounded-xl'>
        <span
          class='block mb-1 text-[10px] text-blue-400 uppercase tracking-wider'
          >Key Symptom</span
        >
        <div class='font-medium text-slate-300 text-xs leading-relaxed'>
          {data.behavior ? data.behavior : 'No specific behavior noted.'}
        </div>
      </div>
    </div>

    {/* --- SCREENSHOT GALLERY --- */}
    {
      data.screenshots && data.screenshots.length > 0 && (
        <div class='mb-12'>
          <h3 class='mb-4 font-bold text-slate-400 text-sm uppercase tracking-wider'>
            Evidence Screenshots
          </h3>
          <div class='gap-4 grid grid-cols-1 md:grid-cols-2'>
            {data.screenshots.map((img) => (
              <a
                href={img}
                target='_blank'
                class='block shadow-sm border border-slate-700 hover:border-slate-500 rounded-lg overflow-hidden transition-shadow'>
                <img
                  src={img}
                  alt='Malware Evidence'
                  class='w-full h-48 object-cover hover:scale-105 transition-transform duration-300'
                />
              </a>
            ))}
          </div>
        </div>
      )
    }

    {/* --- MARKDOWN CONTENT --- */}
    <article class={proseClasses}>
      <Content />
    </article>

    {/* --- CTA FOOTER --- */}
    <div
      class='bg-slate-900 mt-16 p-8 border border-slate-800 rounded-2xl text-center'>
      <h3 class='mb-2 font-bold text-white text-xl'>
        Need help removing this?
      </h3>
      <p class='mb-6 text-slate-400 text-sm'>
        This malware is rated as <span class='font-bold text-white'
          >{data.difficulty}</span
        > difficulty. If you are unsure, do not attempt manual removal.
      </p>
      <a
        href='/hire-me'
        class='inline-block bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold text-white transition-colors'>
        Hire MD Pabel for Cleanup
      </a>
    </div>
  </main>
</Layout>
