---
// src/pages/guides/[...page].astro
import BlogPosts from '../../components/BlogPosts.astro';
import ComponentWrapper from '../../components/component-wrapper.astro';
import Layout from '../../layouts/Layout.astro';
import { wordpress } from '../../lib/wordpress';

export async function getStaticPaths() {
  const PER_PAGE = 10;

  // 1. Fetch all items
  const allGuides = await wordpress.getAllPosts({
    postType: 'guide',
  });

  // 2. Calculate total pages
  const totalPages = Math.ceil(allGuides.length / PER_PAGE);

  // 3. Generate routes manually
  return Array.from({ length: totalPages }, (_, i) => {
    const pageNum = i + 1;
    const start = i * PER_PAGE;
    const end = start + PER_PAGE;
    const pagePosts = allGuides.slice(start, end);

    return {
      // ✅ CRITICAL: For /guides (root) to work, page 1 MUST be undefined
      params: { page: pageNum === 1 ? undefined : pageNum.toString() },
      props: { posts: pagePosts, totalPages, currentPage: pageNum },
    };
  });
}

// ✅ Use props instead of params for the current page to ensure stability
const { posts, totalPages, currentPage } = Astro.props;

// --- Dynamic SEO Settings ---
const isFirstPage = currentPage === 1;
const baseUrl = 'https://www.mdpabel.com/guides';

const seoTitle = isFirstPage
  ? 'WordPress Guides & Tutorials: Security, Malware Removal & Optimization'
  : `Guides & Tutorials (Page ${currentPage}) | WordPress Security`;

const seoDesc = isFirstPage
  ? 'Explore step-by-step WordPress guides on security best practices, malware detection and removal...'
  : `Page ${currentPage} of our WordPress tutorials archive.`;

const canonicalURL = isFirstPage ? baseUrl : `${baseUrl}/${currentPage}`;
---

<Layout
  title={seoTitle}
  description={seoDesc}
  image='/images/blog-opengraph-image.png'
  canonical={canonicalURL}>
  <ComponentWrapper class='pt-12'>
    <BlogPosts
      posts={posts}
      totalPages={totalPages}
      postType='guide'
      rootSlug='guides'
      page={currentPage}
      limit={10}
      title='Security, Malware Removal & Optimization Tutorials'
      shortDescription='Step-by-step tutorials on WordPress security...'
      mode='all'
    />
  </ComponentWrapper>
</Layout>
