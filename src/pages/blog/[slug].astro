---
// src/pages/blog/[slug].astro
import Layout from '../../layouts/Layout.astro';
import ComponentWrapper from '../../components/component-wrapper.astro';
import SinglePost from '../../components/SinglePost.astro';
import { wordpress } from '../../lib/wordpress'; // Type is inferred automatically now
import Banner from '../../components/Banner.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';

// 1. Generate Paths
export async function getStaticPaths() {
  // The API class automatically ensures 'yoast_head' is fetched even if not in 'fields'
  const allPosts = await wordpress.getAllPosts();

  return allPosts.map((post) => {
    // Filter related posts in memory
    const relatedPosts = allPosts
      .filter(
        (p) =>
          p.id !== post.id &&
          p.categories.some((cat) =>
            post.categories.find((c) => c.id === cat.id),
          ),
      )
      .sort(() => 0.5 - Math.random())
      .slice(0, 3);

    return {
      params: { slug: post.slug },
      // ✅ Pass the post (which includes yoastHead) to props
      props: { post, relatedPosts },
    };
  });
}

const { post, relatedPosts } = Astro.props;
---

{/* ✅ PASS 'yoastHead' DIRECTLY. No manual Schema or Title needed. */}
<Layout yoastHead={post.yoastHead}>
  <Banner />

  <ComponentWrapper class='pb-20 max-w-4xl'>
    <SinglePost post={post} parentSlug='blog' />

    <RelatedPosts currentPostId={post.id} posts={relatedPosts} />
  </ComponentWrapper>
</Layout>
